<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARマーカー作成アプリ</title>
  <meta name="description" content="アップロード画像を Hiro マーカー上に表示する AR マーカー生成アプリ (A-Frame + AR.js)" />
  <style>
    :root{--gap:12px}
    body{font-family:system-ui,-apple-system,'Hiragino Kaku Gothic ProN','Noto Sans JP',sans-serif;margin:24px;max-width:980px}
    h1{font-size:1.25rem;margin:0 0 8px}
    .controls{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center;margin:14px 0}
    .preview{border:1px dashed #ccc;padding:10px;background:#fafafa}
    img#previewImg{max-width:300px;max-height:300px;display:block}
    .buttons{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    button,input[type=file]{padding:8px 10px;font-size:14px}
    .note{color:#555;font-size:0.95rem;margin-top:10px}
    .result{margin-top:12px}
    footer{margin-top:28px;color:#666;font-size:0.9rem}
    a.link{display:inline-block;margin-top:6px}
  </style>
</head>
<body>
  <h1>ARマーカー作成アプリ</h1>
  <p>画像をアップロードして、Hiro マーカーに表示する HTML を生成します。生成したファイルはダウンロードしてスマホで開き、印刷した Hiro マーカーをカメラにかざしてください。</p>

  <div class="controls">
    <div>
      <label for="imageInput">画像を選択 (PNG/JPEG)</label><br>
      <input id="imageInput" type="file" accept="image/*">
    </div>

    <div class="preview" id="previewBox" aria-hidden="false">
      <div><strong>プレビュー</strong></div>
      <img id="previewImg" alt="preview" src="" style="display:none">
      <div id="noPreview">画像が選択されていません</div>
    </div>
  </div>

  <div style="margin-top:6px">
    <label><input type="radio" name="mode" value="sandbox" checked> サンドボックスプレビュー（安全）</label>
    <label style="margin-left:12px"><input type="radio" name="mode" value="ar"> AR実機モード（A-Frame + AR.js）</label>
  </div>

  <div class="buttons">
    <button id="generateBtn" disabled>生成</button>
    <button id="openBtn" disabled>新しいタブで開く</button>
    <button id="downloadBtn" disabled>ダウンロード</button>
    <button id="sampleBtn">サンプル画像でテスト</button>
    <button id="hiroBtn">Hiro マーカーを開く（印刷用）</button>
  </div>

  <div class="note">
    <strong>注意:</strong> AR 実機モードは HTTPS とカメラ許可が必要です（GitHub Pages 推奨）。サンドボックスプレビューは AR ではなく、Hiro 風の SVG 上に画像を重ねた静的プレビューです。
  </div>

  <div class="result" id="result"></div>

  <footer>
    <div>使い方の要点: 画像を選択 → 「生成」→ ダウンロードしてスマホで開く → Hiro マーカーをかざす</div>
  </footer>

<script>
/*
  安全ポイント:
  - 親スクリプトが途中で終了するのを避けるため、生成する HTML 内に直接リテラルで </script> を書かないようにしている箇所があります。
  - 生成 HTML を Blob URL としてダウンロード／別タブで開く設計 (サンドボックスでは data: URL による iframe 表示を推奨)。
*/

const imageInput = document.getElementById('imageInput');
const previewImg = document.getElementById('previewImg');
const noPreview = document.getElementById('noPreview');
const generateBtn = document.getElementById('generateBtn');
const openBtn = document.getElementById('openBtn');
const downloadBtn = document.getElementById('downloadBtn');
const sampleBtn = document.getElementById('sampleBtn');
const hiroBtn = document.getElementById('hiroBtn');
const resultDiv = document.getElementById('result');

let uploadedDataUrl = '';
let lastBlobUrl = '';
let lastHtmlString = '';
let lastFilename = 'ar_marker_preview.html';

function fileToDataUrl(file){
  return new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = () => rej(new Error('FileReader error'));
    fr.readAsDataURL(file);
  });
}

imageInput.addEventListener('change', async (e) => {
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(!f.type.startsWith('image/')) return alert('画像ファイルを選択してください');
  try {
    const d = await fileToDataUrl(f);
    uploadedDataUrl = d;
    previewImg.src = d;
    previewImg.style.display = 'block';
    noPreview.style.display = 'none';
    generateBtn.disabled = false;
  } catch(err) {
    console.error(err);
    alert('画像の読み込みに失敗しました');
  }
});

sampleBtn.addEventListener('click', () => {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='#fff'/><circle cx='256' cy='200' r='120' fill='#eee'/><text x='50%' y='85%' text-anchor='middle' font-size='36' fill='#333'>Sample</text></svg>`;
  const data = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  uploadedDataUrl = data;
  previewImg.src = data;
  previewImg.style.display = 'block';
  noPreview.style.display = 'none';
  generateBtn.disabled = false;
});

// Hiro marker image (printable) - external link
hiroBtn.addEventListener('click', () => {
  window.open('https://raw.githubusercontent.com/AR-js-org/AR.js/master/three.js/data/images/HIRO.jpg', '_blank');
});

function getMode(){
  const r = document.querySelector('input[name="mode"]:checked');
  return r ? r.value : 'sandbox';
}

// create safe script tag string (avoid literal </script> in parent source)
function safeScriptTag(src){
  return '<' + 'script src="' + src + '">' + '<' + '/scr' + 'ipt>';
}

// Build AR HTML for real device (contains A-Frame + AR.js)
function buildArHtml(imageDataUrl){
  // small CSS
  const style = 'body{margin:0;font-family:system-ui} .hint{position:fixed;left:8px;top:8px;z-index:999;background:rgba(255,255,255,0.95);padding:8px;border-radius:6px}';
  const head = '<!doctype html>\\n<html lang="ja">\\n<head>\\n<meta charset="utf-8">\\n<meta name="viewport" content="width=device-width,initial-scale=1">\\n<title>AR Preview</title>\\n<meta name="viewport" content="width=device-width,initial-scale=1">\\n<meta http-equiv="Content-Security-Policy" content="default-src \'self\' data: https:; script-src \'self\' https:; style-src \'self\' \'unsafe-inline\' https:; img-src \'self\' data: https:;">\\n<style>' + style + '</style>\\n';
  const scripts = safeScriptTag('https://aframe.io/releases/1.4.2/aframe.min.js') + '\\n' + safeScriptTag('https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js');
  const body = '</head>\\n<body>\\n<div class="hint">カメラを許可して Hiro マーカーをかざしてください（実機で確認してください）</div>\\n';
  const scene = '<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">\\n  <a-marker preset="hiro">\\n    <a-plane src="' + imageDataUrl + '" position="0 0 0" rotation="-90 0 0" width="1" height="0.75"></a-plane>\\n  </a-marker>\\n  <a-entity camera></a-entity>\\n</a-scene>\\n';
  const end = '\\n</body>\\n</html>';
  return head + scripts + body + scene + end;
}

// Build sandbox preview HTML (static SVG marker + overlay image)
function buildSandboxHtml(imageDataUrl){
  const svgMarker = '<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><rect width="100%" height="100%" fill="#fff"/><rect x="48" y="48" width="416" height="416" fill="#000"/><rect x="96" y="96" width="320" height="320" fill="#fff"/><rect x="128" y="128" width="256" height="256" fill="#000"/><text x="50%" y="96%" text-anchor="middle" fill="#333" font-size="18">Hiro-like Marker (preview)</text></svg>';
  const style = 'body{font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#fafafa}.frame{position:relative;width:360px;height:360px;border:1px solid #ddd;background:#fff;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08)}.marker{width:100%;height:100%;display:block}.overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:60%;height:60%;object-fit:contain;border:2px solid rgba(255,255,255,0.7)}';
  const html = '<!doctype html>\\n<html lang="ja">\\n<head>\\n<meta charset="utf-8">\\n<meta name="viewport" content="width=device-width,initial-scale=1">\\n<title>Sandbox Preview</title>\\n<style>' + style + '</style>\\n</head>\\n<body>\\n<div class="frame">\\n  <img class="marker" src="data:image/svg+xml;utf8,' + encodeURIComponent(svgMarker) + '" alt="marker">\\n  <img class="overlay" src="' + imageDataUrl + '" alt="uploaded">\\n</div>\\n</body>\\n</html>';
  return html;
}

// convert string to base64 unicode-safe for data URL
function toBase64Unicode(str){
  return btoa(unescape(encodeURIComponent(str)));
}

function createBlobUrl(html){
  const blob = new Blob([html], { type: 'text/html' });
  return URL.createObjectURL(blob);
}

generateBtn.addEventListener('click', () => {
  if(!uploadedDataUrl) return alert('先に画像を選択してください');
  const mode = getMode();
  if(mode === 'sandbox'){
    const html = buildSandboxHtml(uploadedDataUrl);
    lastHtmlString = html;
    // use base64 data URL in iframe so parent script is not affected
    const b64 = toBase64Unicode(html);
    const dataUrl = 'data:text/html;base64,' + b64;
    // remove previous iframe if any
    const prev = document.querySelector('iframe.previewFrame');
    if(prev) prev.remove();
    const iframe = document.createElement('iframe');
    iframe.className = 'previewFrame';
    iframe.src = dataUrl;
    iframe.sandbox = 'allow-same-origin allow-scripts allow-forms';
    resultDiv.appendChild(iframe);
    // also provide download/open links via Blob (download recommended)
    try {
      const blobUrl = createBlobUrl(html);
      lastBlobUrl = blobUrl;
      downloadBtn.disabled = false;
      openBtn.disabled = false;
      resultDiv.insertAdjacentHTML('beforeend', `<div style="margin-top:8px"><a class="link" href="${blobUrl}" target="_blank" rel="noopener noreferrer">生成したHTMLを新しいタブで開く（Blob）</a></div>`);
    } catch(e) {
      // fallback: create data URL link (may be large and truncated by some browsers)
      resultDiv.insertAdjacentHTML('beforeend', `<div style="margin-top:8px;color:#b33">注意: ダウンロード用の Blob を作成できませんでした。代わりに iframe で表示しています。</div>`);
      downloadBtn.disabled = true;
      openBtn.disabled = true;
    }
  } else {
    // AR実機モード: produce HTML that loads A-Frame and AR.js
    const html = buildArHtml(uploadedDataUrl);
    lastHtmlString = html;
    try {
      const blobUrl = createBlobUrl(html);
      lastBlobUrl = blobUrl;
      downloadBtn.disabled = false;
      openBtn.disabled = false;
      // show link
      resultDiv.innerHTML = `<div class="ok">生成完了（AR実機モード） — ダウンロードして実機で開いてください</div><div style="margin-top:8px"><a class="link" href="${blobUrl}" target="_blank" rel="noopener noreferrer">生成したHTMLを新しいタブで開く（Blob）</a></div>`;
    } catch(e){
      console.error(e);
      alert('生成に失敗しました（Blob 生成エラー）。ブラウザ環境を確認してください。');
    }
  }
});

openBtn.addEventListener('click', () => {
  if(!lastBlobUrl && lastHtmlString){
    try {
      const tmp = createBlobUrl(lastHtmlString);
      window.open(tmp, '_blank');
    } catch(e) {
      alert('新しいタブで開くことができません: ' + e.message);
    }
  } else if(lastBlobUrl) {
    window.open(lastBlobUrl, '_blank');
  } else {
    alert('先に生成してください');
  }
});

downloadBtn.addEventListener('click', () => {
  if(!lastBlobUrl && lastHtmlString){
    try {
      const tmp = createBlobUrl(lastHtmlString);
      const a = document.createElement('a');
      a.href = tmp;
      a.download = lastFilename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch(e) {
      alert('ダウンロードに失敗しました: ' + e.message);
    }
  } else if(lastBlobUrl){
    const a = document.createElement('a');
    a.href = lastBlobUrl;
    a.download = lastFilename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  } else {
    alert('先に生成してください');
  }
});

// cleanup blob URLs on unload
window.addEventListener('unload', () => {
  try{ if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl); }catch(e){}
});
</script>
</body>
</html>

