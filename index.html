<!DOCTYPE html>
<html>
<head>
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒå…±æœ‰ã‚¢ãƒ—ãƒª</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
        #image-upload { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #file-input { margin-right: 10px; }
        button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #upload-status { margin-top: 10px; font-weight: bold; }
        #image-gallery { display: flex; flex-wrap: wrap; gap: 15px; padding-top: 10px; }
        .image-item { border: 1px solid #ccc; padding: 5px; border-radius: 5px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .image-item img { max-width: 150px; max-height: 150px; display: block; border-radius: 3px; object-fit: cover; }
    </style>
</head>
<body>

    <h1>ğŸ“¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒå…±æœ‰</h1>

    <div id="image-upload">
        <input type="file" id="file-input" accept="image/*">
        <button onclick="uploadImage()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <p id="upload-status" style="color: blue;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <hr>

    <h2>ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
    <div id="image-gallery">
        </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // *** ğŸ’¡ StorageBucketã‚’ä¿®æ­£ã—ã¾ã—ãŸ ***
        const firebaseConfig = {
            apiKey: "AIzaSyBvDUbgyy0mjItS9EROQEsWVOj1LdOkkxQ",
            authDomain: "image-aa366.firebaseapp.com",
            projectId: "image-aa366",
            // ğŸ’¡ ä¿®æ­£å¾Œã®ãƒã‚±ãƒƒãƒˆåï¼ˆé€šå¸¸ã¯projectId.appspot.comï¼‰
            storageBucket: "image-aa366.appspot.com", 
            messagingSenderId: "7811593965",
            appId: "1:7811593965:web:58e5fb686c765f4e497ee4"
        };

        // Firebaseã®åˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);

        const storage = firebase.storage();
        const database = firebase.database();
        const galleryRef = database.ref('images');
        const fileInput = document.getElementById('file-input');
        const uploadStatus = document.getElementById('upload-status');
        const imageGallery = document.getElementById('image-gallery');

        /**
         * é¸æŠã•ã‚ŒãŸç”»åƒã‚’Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€
         * ãã®URLã‚’Realtime Databaseã«ä¿å­˜ã™ã‚‹
         */
        function uploadImage() {
            const file = fileInput.files[0];

            if (!file) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            uploadStatus.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

            // Storageã«ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½œæˆ
            const fileName = `${new Date().getTime()}_${file.name}`;
            const storageRef = storage.ref(`gallery_images/${fileName}`);

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const uploadTask = storageRef.put(file);

            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’ç›£è¦–
            uploadTask.on('state_changed',
                (snapshot) => {
                    // é€²æ—è¡¨ç¤º
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadStatus.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­: ${progress.toFixed(2)}%`;
                },
                (error) => {
                    // ã‚¨ãƒ©ãƒ¼å‡¦ç†
                    console.error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
                    // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                    uploadStatus.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•— (${error.code}): ${error.message}`; 
                    alert(`ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code}`);
                },
                () => {
                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã®å‡¦ç†
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL:', downloadURL);
                        uploadStatus.textContent = 'âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';

                        // Realtime Databaseã«ç”»åƒã®URLã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
                        galleryRef.push({
                            url: downloadURL,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        }).catch(err => {
                            console.error("DBã¸ã®æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
                            uploadStatus.textContent += ` (DBã‚¨ãƒ©ãƒ¼: ${err.message})`;
                        });

                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                        fileInput.value = '';
                    });
                }
            );
        }

        /**
         * Realtime Databaseã®å¤‰æ›´ã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã€
         * ç”»åƒãŒè¿½åŠ ã•ã‚ŒãŸã¨ãã«ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’æ›´æ–°ã™ã‚‹
         */
        // ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„é †ã«å–å¾—ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é †åºä»˜ã‘ã‚’è¡Œã„ã¾ã›ã‚“ã€‚
        // ä»£ã‚ã‚Šã«ã€child_addedã‚¤ãƒ™ãƒ³ãƒˆã§DOMã®å…ˆé ­ã«æŒ¿å…¥ã—ã¾ã™ã€‚
        galleryRef.on('child_added', (snapshot) => {
            const imageItem = snapshot.val();
            const key = snapshot.key;

            // æ—¢ã«DOMã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ (é‡è¤‡è¡¨ç¤ºé˜²æ­¢)
            if (document.getElementById(`image-${key}`)) {
                return;
            }

            // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¿½åŠ ã™ã‚‹DOMè¦ç´ ã‚’ä½œæˆ
            const div = document.createElement('div');
            div.className = 'image-item';
            div.id = `image-${key}`;

            const img = document.createElement('img');
            img.src = imageItem.url;
            img.alt = 'å…±æœ‰ç”»åƒ';
            img.title = new Date(imageItem.timestamp).toLocaleString(); // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã«æ™‚é–“ã‚’è¡¨ç¤º

            div.appendChild(img);
            
            // å¸¸ã«æœ€æ–°ã®ç”»åƒã‚’å…ˆé ­ã«è¿½åŠ  (æœ€æ–°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ç”»åƒãŒä¸€ç•ªä¸Šã«æ¥ã‚‹)
            imageGallery.insertBefore(div, imageGallery.firstChild);
        });
    </script>

</body>
</html>
